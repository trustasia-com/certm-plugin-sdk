name: Release

on:
  push:
    tags: ['v*']

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true
      
      - name: Run tests
        run: |
          go mod download
          go test -v ./...
      
      - name: Setup TinyGo
        run: |
          wget -q https://github.com/tinygo-org/tinygo/releases/download/v0.30.0/tinygo_0.30.0_amd64.deb
          sudo dpkg -i tinygo_0.30.0_amd64.deb
      
      - name: Build WASM
        working-directory: ./example
        run: |
          tinygo build -o plugin.wasm -target=wasi main.go
          ls -lh plugin.wasm
      
      - name: Generate changelog
        id: changelog
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          PREV=$(git describe --tags --abbrev=0 ${TAG}^ 2>/dev/null || echo "")
          if [ -z "$PREV" ]; then
            CHANGES=$(git log --pretty=format:"- %s (%h)" $TAG)
          else
            CHANGES=$(git log --pretty=format:"- %s (%h)" $PREV..$TAG)
          fi
          {
            echo "changes<<EOF"
            echo "$CHANGES"
            echo "EOF"
          } >> $GITHUB_OUTPUT
      
      - uses: softprops/action-gh-release@v2
        with:
          name: Release ${GITHUB_REF#refs/tags/}
          body: |
            ## 更新内容
            ${{ steps.changelog.outputs.changes }}
            
            ## 安装
            ```bash
            go get github.com/trustasia-com/certm-plugin-sdk@${GITHUB_REF#refs/tags/}
            ```
            
            ## 要求
            - Go 1.21+
            - TinyGo 0.30.0+ (编译WASM)
          files: example/plugin.wasm
          prerelease: ${{ contains(github.ref_name, '-') }}
